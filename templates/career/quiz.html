<script>
let currentQuestion = 1;
const totalQuestions = 3; // Update this based on actual questions
let responses = {};

// ============== PROGRESS SAVE/RESTORE ==============

// On page load - check for saved progress
window.addEventListener('DOMContentLoaded', function() {
    const savedProgress = localStorage.getItem('quizProgress');
    
    if (savedProgress) {
        try {
            const data = JSON.parse(savedProgress);
            
            // Show restore dialog
            if (confirm('You have an unfinished quiz. Do you want to continue where you left off?')) {
                // Restore progress
                currentQuestion = data.currentQuestion || 1;
                responses = data.responses || {};
                
                // Show saved question
                document.querySelectorAll('.question-slide').forEach(slide => {
                    slide.classList.remove('active');
                });
                document.querySelector(`.question-slide[data-question="${currentQuestion}"]`).classList.add('active');
                
                // Update UI
                document.getElementById('currentQ').textContent = currentQuestion;
                updateProgressBar();
                updateButtons();
                
                // Restore selected answers
                restoreAnswers();
                
                console.log('Progress restored!');
            } else {
                // Clear saved progress
                clearProgress();
            }
        } catch (e) {
            console.error('Error restoring progress:', e);
            clearProgress();
        }
    }
});

// Save progress to localStorage
function saveProgress() {
    const progressData = {
        currentQuestion: currentQuestion,
        responses: responses,
        timestamp: new Date().getTime()
    };
    
    try {
        localStorage.setItem('quizProgress', JSON.stringify(progressData));
        console.log('Progress saved!');
    } catch (e) {
        console.error('Error saving progress:', e);
    }
}

// Clear progress from localStorage
function clearProgress() {
    localStorage.removeItem('quizProgress');
    console.log('Progress cleared!');
}

// Restore selected answers in UI
function restoreAnswers() {
    Object.keys(responses).forEach(questionKey => {
        const questionNum = questionKey.replace('q', '');
        const value = responses[questionKey];
        
        // Find and check the radio button
        const radio = document.querySelector(`input[name="q${questionNum}"][value="${value}"]`);
        if (radio) {
            radio.checked = true;
        }
    });
}

// ============== QUIZ LOGIC ==============

document.getElementById('totalQ').textContent = totalQuestions;

// Enable next button when option selected
document.querySelectorAll('input[type="radio"]').forEach(radio => {
    radio.addEventListener('change', function() {
        document.getElementById('nextBtn').disabled = false;
        
        // Save progress immediately when answer selected
        const currentSlide = document.querySelector(`.question-slide[data-question="${currentQuestion}"]`);
        const selected = currentSlide.querySelector('input[type="radio"]:checked');
        if (selected) {
            responses[`q${currentQuestion}`] = selected.value;
            saveProgress();
        }
    });
});

function updateProgressBar() {
    const progress = (currentQuestion / totalQuestions) * 100;
    document.getElementById('progressBar').style.width = progress + '%';
}

function updateButtons() {
    // Previous button
    document.getElementById('prevBtn').disabled = currentQuestion === 1;
    
    // Next button - check if answer selected
    const currentSlide = document.querySelector(`.question-slide[data-question="${currentQuestion}"]`);
    const hasAnswer = currentSlide.querySelector('input[type="radio"]:checked') !== null;
    document.getElementById('nextBtn').disabled = !hasAnswer;
    
    // Show/hide submit button
    if (currentQuestion === totalQuestions) {
        document.getElementById('nextBtn').style.display = 'none';
        document.getElementById('submitBtn').style.display = 'block';
    } else {
        document.getElementById('nextBtn').style.display = 'block';
        document.getElementById('submitBtn').style.display = 'none';
    }
}

function nextQuestion() {
    // Save current answer
    const currentSlide = document.querySelector(`.question-slide[data-question="${currentQuestion}"]`);
    const selected = currentSlide.querySelector('input[type="radio"]:checked');
    
    if (selected) {
        responses[`q${currentQuestion}`] = selected.value;
        saveProgress();
        
        // Hide current question
        currentSlide.classList.remove('active');
        
        // Move to next
        currentQuestion++;
        
        if (currentQuestion <= totalQuestions) {
            // Show next question
            document.querySelector(`.question-slide[data-question="${currentQuestion}"]`).classList.add('active');
            document.getElementById('currentQ').textContent = currentQuestion;
            
            // Update progress bar
            updateProgressBar();
            
            // Update buttons
            updateButtons();
        }
    }
}

function previousQuestion() {
    if (currentQuestion > 1) {
        // Hide current question
        document.querySelector(`.question-slide[data-question="${currentQuestion}"]`).classList.remove('active');
        
        // Move to previous
        currentQuestion--;
        
        // Show previous question
        document.querySelector(`.question-slide[data-question="${currentQuestion}"]`).classList.add('active');
        document.getElementById('currentQ').textContent = currentQuestion;
        
        // Update progress bar
        updateProgressBar();
        
        // Update buttons
        updateButtons();
    }
}

function submitQuiz() {
    // Save last answer
    const currentSlide = document.querySelector(`.question-slide[data-question="${currentQuestion}"]`);
    const selected = currentSlide.querySelector('input[type="radio"]:checked');
    
    if (!selected) {
        alert('Please select an option');
        return;
    }
    
    responses[`q${currentQuestion}`] = selected.value;
    
    // Count category frequencies
    const categoryScores = {
        technical: 0,
        creative: 0,
        social: 0,
        analytical: 0,
        entrepreneurial: 0
    };
    
    Object.values(responses).forEach(value => {
        if (categoryScores.hasOwnProperty(value)) {
            categoryScores[value]++;
        }
    });
    
    // Show loading
    document.getElementById('quizContainer').style.display = 'none';
    document.getElementById('loadingState').style.display = 'block';
    
    // Send to backend
    fetch('/career/quiz', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(categoryScores)
    })
    .then(response => response.json())
    .then(data => {
        // Clear saved progress (quiz completed)
        clearProgress();
        
        // Redirect to results page with data
        sessionStorage.setItem('quizResults', JSON.stringify(data));
        window.location.href = '/career/results';
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Something went wrong. Please try again.');
        document.getElementById('quizContainer').style.display = 'block';
        document.getElementById('loadingState').style.display = 'none';
    });
}

// Auto-save every 30 seconds (optional)
setInterval(() => {
    if (Object.keys(responses).length > 0) {
        saveProgress();
    }
}, 30000);

// Clear progress when user intentionally restarts
document.querySelector('a[href="/career"]')?.addEventListener('click', function() {
    if (confirm('This will clear your current progress. Continue?')) {
        clearProgress();
    } else {
        event.preventDefault();
    }
});
</script>